name: Discord Commit Notification

on:
  pull_request:
    types:
      - closed
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    # Only run when a release-please PR is merged
    if: github.event.pull_request.merged == true && startsWith(github.event.pull_request.head.ref, 'release-please--')
    steps:
      - name: Fetch and process commits
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Save commits to file to avoid bash/JSON quoting issues
          curl -s \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/commits?per_page=100" \
            > /tmp/commits.json

          python3 - <<'PYEOF'
import json, os

with open('/tmp/commits.json') as f:
    data = json.load(f)

lines = []
feat_lines = []
for c in data:
    msg = c['commit']['message'].splitlines()[0]
    sha = c['sha'][:7]
    url = c['html_url']
    # Skip release-please metadata and merge commits
    if msg.startswith('chore') or msg.startswith('Merge '):
        continue
    line = f'[`{sha}`]({url}) {msg}'
    lines.append(line)
    if msg.startswith('feat'):
        feat_lines.append(line)

body = '\n'.join(lines) if lines else 'No changes.'
if len(body) > 3900:
    body = body[:3900] + '\n...'

feat_body = '\n'.join(feat_lines)

with open(os.environ['GITHUB_ENV'], 'a') as f:
    f.write(f'COMMIT_LINES<<ENVEOF\n{body}\nENVEOF\n')
    f.write(f"HAS_FEATS={'true' if feat_lines else 'false'}\n")
    f.write(f'FEAT_LINES<<ENVEOF\n{feat_body}\nENVEOF\n')
PYEOF

      - name: Send to Discord
        env:
          DISCORD_COMMITS_WEBHOOK: ${{ secrets.DISCORD_COMMITS_WEBHOOK }}
          DISCORD_FEAT_WEBHOOK: ${{ secrets.DISCORD_FEAT_WEBHOOK }}
        run: |
          ESCAPED_TITLE=$(echo "${{ github.event.pull_request.title }}" | sed 's/"/\\"/g')
          BODY=$(python3 -c "import json,os; print(json.dumps(os.environ.get('COMMIT_LINES','')))")

          PAYLOAD=$(cat <<EOF
          {
            "embeds": [{
              "title": "${ESCAPED_TITLE}",
              "color": 7291618,
              "description": ${BODY}
            }]
          }
          EOF
          )

          curl -s -X POST "$DISCORD_COMMITS_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD"

          # Post only feat commits to #feats if any exist
          if [ "$HAS_FEATS" = "true" ]; then
            FEAT_BODY=$(python3 -c "import json,os; print(json.dumps(os.environ.get('FEAT_LINES','')))")
            FEAT_PAYLOAD=$(cat <<EOF
          {
            "embeds": [{
              "title": "${ESCAPED_TITLE}",
              "color": 7291618,
              "description": ${FEAT_BODY}
            }]
          }
          EOF
            )
            curl -s -X POST "$DISCORD_FEAT_WEBHOOK" \
              -H "Content-Type: application/json" \
              -d "$FEAT_PAYLOAD"
          fi
